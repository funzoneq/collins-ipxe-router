#!ipxe

# http://ipxe.org/scripting

<% if action == :intake or action == :provision or action == :testing %>

:router_menu
menu Collins iPXE Router 1.0.1
item --key 0 local 0: Local Boot - Boot the hard drive
item --key 1 intake 1: Intake - Register with Collins and run machine setup
item --key 2 testing 2: Intake testing - Test the new version of On My Way
item --key 3 provision 3: Provision - Install CentOS 6

choose --default <%= action %> --timeout 10000 target && goto ${target}

:local
sanboot --no-describe --drive 0x80 || goto router_menu

:intake
initrd <%= image_server %>/omw/initrd0.img
kernel <%= image_server %>/omw/vmlinuz0 rootflags=loop rootflags=loop root=live:/omw.iso rootfstype=auto ro liveimg SCRIPT_CMD=/usr/bin/getstarted GITURL=<%= git_url %> playbook=<%= playbook %> rd_NO_LUKS rd_NO_MD rd_NO_DM console=tty0 console=ttyS1,115200
goto finish

:testing
initrd <%= image_server %>/omw_test/initrd0.img
kernel <%= image_server %>/omw_test/vmlinuz0 rootflags=loop rootflags=loop root=live:/omw.iso rootfstype=auto ro liveimg SCRIPT_CMD=/usr/bin/getstarted GITURL=<%= git_url %> playbook=<%= playbook %> rd_NO_LUKS rd_NO_MD rd_NO_DM console=tty0 console=ttyS1,115200
goto finish

:provision
initrd <%= image_server %>/centos/x86_64/initrd.img
kernel <%= image_server %>/centos/x86_64/vmlinuz ks=<%= kickstart %> ramdisk_size=100000
goto finish

# Avoid redownloading initrd and kernel repeatedly
:finish

<% else %>

<% pp action %>

echo
echo Attempting to boot from local drive
echo
sanboot --no-describe --drive 0x80

<% end %>