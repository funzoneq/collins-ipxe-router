#Generated by Kickstart Configurator
#platform=x86

# Fetch content from here
url --url <%= ubuntu_mirror %>

#System language
lang en_US.UTF-8

#Language modules to install
langsupport en_US.UTF-8

#System keyboard
keyboard us

#System timezone
timezone Etc/UTC

#Enable debug logging
logging --level=debug

#Root password
rootpw --disabled

#Initial user (user with sudo capabilities) 
user <%= initial_user %> --fullname "<%= initial_fullname %>" --iscrypted <%= passwd_hash %>

# Use cmdline mode install for more debugging than text
cmdline

# Do not configure the X Window System
skipx

#Install OS instead of upgrade
install

#Clear the Master Boot Record
zerombr yes

#Partition clearing information
clearpart --initlabel --all

#System bootloader configuration
<% if asset.nodeclass == 'edge' %>
bootloader --location=mbr -–driveorder=sda,sdb,sdc
<% else %>
bootloader --location=mbr
<% end %>

#Basic disk partition
part swap       --size 16384
part /          --fstype ext4 --size 1 --grow --asprimary
part /boot      --fstype ext4 --size 512 --asprimary
part /tmp       --fstype ext4 --size 5120

#System authorization infomation
auth  --useshadow  --enablemd5

#Network information
network --bootproto=dhcp --hostname=<%= asset.hostname %>

#Firewall configuration
firewall --disabled

#Reboot after installation
reboot

#Package install information
%packages
ubuntu-minimal
openssh-server
screen
curl
wget
acpid
unattended-upgrades
linux-image-generic
python-apt
lshw
lldpd
dmidecode
ifenslave-2.6
ethtool
xfsprogs

<% if asset.nodeclass == 'edge' %>
%pre --interpreter=/bin/bash
# This is the trick — automatically switch to 6th console
exec < /dev/tty6 > /dev/tty6 2> /dev/tty6
chvt 6

dd if=/dev/zero of=/dev/sdb bs=512 count=1
dd if=/dev/zero of=/dev/sdc bs=512 count=1

cat <<EOF | sudo parted ---pretend-input-tty /dev/sdb
mklabel gpt
yes
yes
mkpart primary ext4 0% 100%
quit
EOF

cat <<EOF | sudo parted ---pretend-input-tty /dev/sdc
mklabel gpt
yes
yes
mkpart primary xfs 0% 100%
quit
EOF

# Then switch back to Anaconda on the first console
chvt 1
exec < /dev/tty1 > /dev/tty1 2> /dev/tty1
%end
<% end %>

%post --interpreter=/bin/bash

# This is the trick — automatically switch to 6th console
exec < /dev/tty6 > /dev/tty6 2> /dev/tty6
chvt 6

wget <%= baseurl %>/postinstall/<%= asset.tag %> -O /root/postinstall.sh
chmod +x /root/postinstall.sh
/root/postinstall.sh
rm /root/postinstall.sh

# We can break into a shell prompt for debugging
# /bin/sh

# Then switch back to Anaconda on the first console
chvt 1
exec < /dev/tty1 > /dev/tty1 2> /dev/tty1

