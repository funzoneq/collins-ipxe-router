<%
bond0 = asset.public_address
bond1 = asset.backend_address
%>
#Generated by Kickstart Configurator
#platform=x86

# Fetch content from here
url â€“url <%= ubuntu_mirror %>

#System language
lang en_US.UTF-8

#Language modules to install
langsupport en_US.UTF-8

#System keyboard
keyboard us

#System timezone
timezone Etc/UTC

#Root password
rootpw --disabled

#Initial user (user with sudo capabilities) 
user <%= initial_user %> --fullname "<%= initial_fullname %>" --password <%= initial_pass %>

#Reboot after installation
reboot

# Use cmdline mode install for more debugging than text
cmdline

# Do not configure the X Window System
skipx

#Install OS instead of upgrade
install

#System bootloader configuration
bootloader --location=mbr 

#Clear the Master Boot Record
zerombr yes

#Partition clearing information
clearpart --all --initlabel 

#Basic disk partition
part / --fstype ext4 --size 1 --grow --asprimary 
part swap --size 1024 
part /boot --fstype ext4 --size 512 --asprimary

#System authorization infomation
auth  --useshadow  --enablemd5

#Network information
network --bootproto=dhcp --hostname=<%= asset.hostname %>

#Firewall configuration
firewall --disabled

#Package install information
%packages
ubuntu-minimal
openssh-server
screen
curl
wget
acpid
unattended-upgrades
linux-image-generic
python-apt
lshw
lldpd
dmidecode
ifenslave-2.6
ethtool
-apparmor
-apparmor-utils

%post

# add normal apt source list
(
cat <<'EOF'
deb <%= ubuntu_mirror %> trusty main universe restricted
deb <%= ubuntu_mirror %> trusty-updates main universe restricted
deb http://security.ubuntu.com/ubuntu trusty-security main universe restricted
EOF
) > /etc/apt/sources.list
apt-get update
apt-get upgrade -y

# add network config
echo "alias netdev-bond0 bonding\nalias netdev-bond1 bonding" > /etc/modprobe.d/bonding.conf
(
cat << 'EOF'
# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto eth0
iface eth0 inet manual
bond-master bond0

auto eth1
iface eth1 inet manual
bond-master bond0

auto eth2
iface eth2 inet manual
bond-master bond1

auto eth3
iface eth3 inet manual
bond-master bond1

auto bond1
iface bond1 inet static
address <%= bond1.address %>
netmask  <%= bond1.netmask %>
bond-mode 5
bond-miimon 100
bond-slaves none

auto bond0
iface bond0 inet static
	address <%= bond0.address %>
	netmask <%= bond0.netmask %>
	gateway <%= bond0.gateway %>
	dns-nameservers <%= recursive_dns.join(" ") %>
	bond-mode 5
	bond-miimon 100
	bond-slaves none

iface bond0 inet6 static
	address 2001:0DB8::<%= bond0.address.split(".")[3] %>
	netmask 64
	gateway 2001:0DB8::1
EOF
) > /etc/network/interfaces

# setup locales
locale-gen en_US.UTF-8
update-locale LANG="en_US.UTF-8"
echo 'LANG=en_US.UTF-8' >> /etc/environment
echo 'LC_ALL=en_US.UTF-8' >> /etc/environment
