#!/bin/bash

<%= 
content = File.read(File.expand_path("views/network/#{asset.nodeclass}.erb"))
ERB.new(content).result(binding)
%>

<% if asset.nodeclass == 'edge' %>
mkfs.ext4 /dev/sdb1
mkfs.xfs /dev/sdc1

mkdir /cache
mkdir /var/log/nginx

UUID=$(blkid -o value -s UUID /dev/sdb1)

cat << EOF >> /etc/fstab
# /var/log/nginx was on /dev/sdb1 during installation
UUID=$UUID /var/log/nginx   ext4    defaults    0   0
EOF

UUID=$(blkid -o value -s UUID /dev/sdc1)

cat << EOF >> /etc/fstab
# /cache was on /dev/sdc1 during installation
UUID=$UUID /cache   xfs    defaults    0   0
EOF
<% end %>

# Update collins status to Provisioned cause we are done
/usr/bin/curl --basic -H "Accept: text/plain" -u '<%= collins.username %>:<%= collins.password %>' -d 'status=Provisioned' -d 'reason=Kickstarted' -d 'state=RUNNING' <%= collins.host %>/api/asset/<%= asset.tag %>/status
